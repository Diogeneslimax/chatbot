<?php

$config = array(

    'BOT_ID' => '412',
    'CLIENT_ID' => 'bcr7mc35ek4qe9af5b2owxw05s8zi2hq',
    'URL' => 'https://uctdemo.bitrix24.com/rest/80/b3tccjddff2i2q0a/',

    //Uras do sistema
    'SAUDACAO' => "Ol√°! Que bom que voc√™ entrou em contato...",
    'SUB_URA_3' => "Com qual area deseja falar?%0A%0A1 - Bitrix24%0A2 - Telefonia%0A9 - Voltar ao menu anterior",
    'CAPTURA_NOME' => "Poderia me informar o seu nome?",
    'CAPTURA_TELEFONE' => ', se necess√°rio, vamos entrar em contato por telefone para prosseguir com o seu atendimento de forma mais personalizada. Para isso, deixe aqui abaixo o seu melhor n√∫mero. Com DDD, t√° bom?',
    'CAPTURA_EMAIL' => ', agora me fala seu e-mail, por favor...',
    'URA' => ', para saber como te ajudar da melhor forma, preciso que voc√™ digite o n√∫mero que corresponde ao motivo desse contato: %0A' . 
    '1 - Quero saber mais sobre a Conta PJ do C6 Bank; %0A' . 
    '2 - Quero saber sobre cr√©dito para empresas; %0A' . 
    '3 - Quero dar um falar com um atendente;',
    //Grupos
    'COMERCIAL' => '148',
    'BITRIX' => '150',
    'TELEFONIA' => '152',
    'FINANCEIRO' => '154',

    // Pesquisar funcion√°rios
    'SRC_USER' => 'https://uctdemo.bitrix24.com/rest/12/z2fsucx4hgkw2im3/',


    'URA_ERRO' => "Eroo",
);



function menu_ura($mensagem = NULL, $atual = NULL, $metodos, $conn, $config, $row = null)
{

   
    if(mb_strpos($mensagem, '=== Outgoing message, author: Bitrix24 (')){
        
        //Captura do nome do usu√°rio que enviou a mensagem pelo Wazzup
        $pos = strpos($mensagem, '(');
        $nome = substr($mensagem, ($pos + 1), -1);
        $pos = strpos($nome, ')');
        $nome = substr($nome, 0, $pos);
        //--------------------------------

        file_put_contents(__DIR__ . '/imbot.log', "\n" . 'Mensagem do Wazzup detectada com o nome: ' . $nome , FILE_APPEND);
        
        $IDUSER = getUserByName($config['SRC_USER'], 'user.search.json?', $nome);

        file_put_contents(__DIR__ . '/imbot.log', "\n" . "ID: $IDUSER encontrado!", FILE_APPEND);

        controler_bot($config['URL'], $metodos['TRANSFERIR'], array(
                
            'BOT_ID=' . $config['BOT_ID'] . '&',
            'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
            'CHAT_ID=' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
            'LEAVE=Y'  . '&',
            'TRANSFER_ID=' . $IDUSER
            
            )); 
    }else{



        if (!is_null($atual)) {

            $navegador = $atual;
            $controler = 1;
        } else {
    
            $navegador = $mensagem;
            $controler = 0;
        }
    
    
    
    
        switch ($navegador) {
    
            case '1':
    
                controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                    'BOT_ID=' . $config['BOT_ID'] . '&',
                    'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                    'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                    'MESSAGE=Excelente escolha! O C6 Bank hoje √© o √∫nico banco que oferece uma conta PJ TOTALMENTE gratuita e benef√≠cios incr√≠veis...'
                    
                    
                ));

                sleep(0.5);

                controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                    'BOT_ID=' . $config['BOT_ID'] . '&',
                    'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                    'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                    'MESSAGE=Cesta de servi√ßos, pix e tag de ped√°gio GR√ÅTIS, desconto na conta de luz de at√© 12%, cart√£o de cr√©dito sem anuidade e sua empresa ainda pode ter CR√âDITO APROVADO mediante solicita√ß√£o.'
                    
                    
                ));

                sleep(0.5);
                
                controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                    'BOT_ID=' . $config['BOT_ID'] . '&',
                    'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                    'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                    'MESSAGE=' . $row['NOME'] . ', voc√™ tem interesse? %0A' .
                    '1 - Claro! Quero abrir a minha conta agora! %0A' . 
                    '2 - N√£o, n√£o tenho interesse em economizar.%0A' . 
                    '0 - Voltar ao menu anterior.'
                    
                    
                ));

                if ($controler == 1) {
    
                    switch ($mensagem) {
    
                        case '1':
                            controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                                'BOT_ID=' . $config['BOT_ID'] . '&',
                                'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                                'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                                'MESSAGE=Perfeito! Em breve, um de nossos atendentes entrar√° em contato para dar in√≠cio j√° √† abertura da sua conta e garantir tudo isso e muito mais para a sua empresa. üòä'
                                
                                
                            ));

                            sleep(0.5);
                            
                            controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                                'BOT_ID=' . $config['BOT_ID'] . '&',
                                'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                                'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                                'MESSAGE=Ou ent√£o, entre em contato agora pelo nosso WhatsApp atrav√©s do link: wa.me/552139008295'
                                
                                
                            ));
    
                            break;
    
                        case '2':

    
                            break;
    
                       
    
                        case '0':
    
                            menu_ura(0, "" , $metodos, $conn, $config);
    
                            $query = "DELETE FROM conversas  WHERE CHAT_ID = '" . $_REQUEST['data']['PARAMS']['CHAT_ID'] . "' AND URL = '" . $_REQUEST['auth']['domain'] . "'";
    
                            $result = mysqli_query($conn, $query);
    
                            break;
    
                        default:
    
                            controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                                'BOT_ID=' . $config['BOT_ID'] . '&',
                                'CLIENT_ID=' . $config['CLIENT_ID'] . '&',
                                'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                                'MESSAGE=' . $config['SUB_URA_3']
    
                            ));
    
                            break;
                        }
                }

                break;
    
            case '2':
    
                controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                    'BOT_ID=' . $config['BOT_ID'] . '&',
                    'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                    'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                    'MESSAGE=Excelente escolha! O C6 Bank hoje √© o √∫nico banco que oferece uma conta PJ TOTALMENTE gratuita e benef√≠cios incr√≠veis...'
                    
                    
                ));
                
                controler_bot($config['URL'], $metodos['ENVIAR'], array(

                    'BOT_ID=' . $config['BOT_ID'] . '&',
                    'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                    'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                    'MESSAGE=Excelente escolha! O C6 Bank hoje √© o √∫nico banco que oferece uma conta PJ TOTALMENTE gratuita e benef√≠cios incr√≠veis...'
                    
                        
                ));
                    
                    controler_bot($config['URL'], $metodos['TRANSFERIR'], array(
                    
                    'BOT_ID=' . $config['BOT_ID'] . '&',
                    'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                    'CHAT_ID=' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                    'LEAVE=Y'  . '&',
                    'QUEUE_ID=' . $config['FINANCEIRO']
                    
                    )); 
    
                    $query = "DELETE FROM conversas WHERE CHAT_ID = " . $_REQUEST['data']['PARAMS']['CHAT_ID'];    
        
                    $result = mysqli_query($conn, $query);
    
    
                break;
    
            case '3':
    
                if ($controler == 1) {
    
                    switch ($mensagem) {
    
                        case '1':
    
                            controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                                'BOT_ID=' . $config['BOT_ID'] . '&',
                                'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                                'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                                'MESSAGE=Algu√™m da equipe de Bitrix24 j√° ira atender voc√™'
                                
    
                            ));
    
                            controler_bot($config['URL'], $metodos['TRANSFERIR'], array(
    
                                
                                'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                                'CHAT_ID=' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',                            
                                'QUEUE_ID=' . $config['BITRIX'] . '&',
                                'LEAVE=' . "Y",
    
                            ));  
    
                            $query = "DELETE FROM conversas WHERE CHAT_ID = " . $_REQUEST['data']['PARAMS']['CHAT_ID'];    
    
                            $result = mysqli_query($conn, $query);
    
                            break;
    
                        case '2':
    
                            controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                                'BOT_ID=' . $config['BOT_ID'] . '&',
                                'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                                'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                                'MESSAGE=Algu√™m da equipe de telefonia j√° ira atender voc√™'
                                
    
                            ));
    
                            controler_bot($config['URL'], $metodos['TRANSFERIR'], array(
    
                                'BOT_ID=' . $config['BOT_ID'] . '&',
                                'CLIENT_ID=' . $config['CLIENT_ID'] . '&',                            
                                'CHAT_ID=' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                                'LEAVE=Y'  . '&',
                                'QUEUE_ID=' . $config['TELEFONIA']
    
                            ));  
    
                            $query = "DELETE FROM conversas WHERE CHAT_ID = " . $_REQUEST['data']['PARAMS']['CHAT_ID'];    
    
                            $result = mysqli_query($conn, $query);
    
                            break;
    
                       
    
                        case '9':
    
                            menu_ura(0, "" , $metodos, $conn, $config);
    
                            $query = "DELETE FROM conversas  WHERE CHAT_ID = '" . $_REQUEST['data']['PARAMS']['CHAT_ID'] . "' AND URL = '" . $_REQUEST['auth']['domain'] . "'";
    
                            $result = mysqli_query($conn, $query);
    
                            break;
    
                        default:
    
                            controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                                'BOT_ID=' . $config['BOT_ID'] . '&',
                                'CLIENT_ID=' . $config['CLIENT_ID'] . '&',
                                'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                                'MESSAGE=' . $config['SUB_URA_3']
    
                            ));
    
                            break;
                        }
                } else {
    
                    $query = "UPDATE conversas SET URA = '" . $navegador . "' WHERE CHAT_ID = '" . $_REQUEST['data']['PARAMS']['CHAT_ID'] . "' AND URL = '" . $_REQUEST['auth']['domain'] . "'";
    
                    $result = mysqli_query($conn, $query);
    
                    controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                        'BOT_ID=' . $config['BOT_ID'] . '&',
                        'CLIENT_ID=' . $config['CLIENT_ID'] . '&',
                        'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                        'MESSAGE=' . $config['SUB_URA_3']
    
                    ));
                }
    
                break;       
    
                case '9':
    
    
                    break;
    
                case '999':
    
    
                    break;
    
            default:
    
                controler_bot($config['URL'], $metodos['ENVIAR'], array(
    
                    'BOT_ID=' . $config['BOT_ID'] . '&',
                    'CLIENT_ID=' . $config['CLIENT_ID'] . '&',
                    'DIALOG_ID=chat' . $_REQUEST['data']['PARAMS']['CHAT_ID'] . '&',
                    'MESSAGE=' . $config['URA_ERRO']
    
                ));
    
                break;
        }
    }

}

?>